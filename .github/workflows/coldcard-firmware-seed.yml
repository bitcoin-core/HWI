name: Coldcard Firmware Seed
on:
  workflow_call:

jobs:
  seed:
    name: Seed Coldcard firmware (once per run)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Clone Coldcard firmware (with submodules)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p test/work
          git clone --recursive https://github.com/Coldcard/firmware.git test/work/firmware
          git -C test/work/firmware submodule sync --recursive
          git -C test/work/firmware -c protocol.version=2 submodule update --init --recursive --jobs 8

      - name: Apply HWI patch
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.email "ci@ci.com"
          git config --global user.name "ci"
          git -C test/work/firmware am ../../data/coldcard-multisig.patch

      - name: Upload seeded repo as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coldcard-firmware-src
          path: test/work/firmware
